angular.module("ui.colorpicker",[]).factory("colorpicker.helper",["$document",function(o){return{setCookie:function(o,t){var e=30,r=new Date;r.setTime(r.getTime()+24*e*60*60*1e3),document.cookie=o+"="+escape(t)+";expires="+r.toGMTString()},getCookie:function(o){var t,e=new RegExp("(^| )"+o+"=([^;]*)(;|$)");return(t=document.cookie.match(e))?unescape(t[2]):null},deleteCookie:function(o){var t=new Date;t.setTime(t.getTime()-1);var e=getCookie(o);null!=e&&(document.cookie=o+"="+e+";expires="+t.toGMTString())},enabledCookie:function(o){return"string"==typeof this.getCookie(o)?!0:!1},stringParsers:[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(o){return[o[1],o[2],o[3],o[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(o){return[2.55*o[1],2.55*o[2],2.55*o[3],o[4]]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,parse:function(o){return[parseInt(o[1],16),parseInt(o[2],16),parseInt(o[3],16)]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/,parse:function(o){return[parseInt(o[1]+o[1],16),parseInt(o[2]+o[2],16),parseInt(o[3]+o[3],16)]}}]}}]).factory("colorpicker.transColor",["colorpicker.helper",function(o){return{value:{h:1,s:1,b:1,a:1},rgb:function(){var o=this.toRGB();return"rgb("+o.r+","+o.g+","+o.b+")"},rgba:function(){var o=this.toRGB();return"rgba("+o.r+","+o.g+","+o.b+","+o.a+")"},hex:function(){return this.toHex()},RGBtoHSB:function(o,t,e,r){o/=255,t/=255,e/=255;var n,i,s,a;return s=Math.max(o,t,e),a=s-Math.min(o,t,e),n=0===a?null:s===o?(t-e)/a:s===t?(e-o)/a+2:(o-t)/a+4,n=(n+360)%6*60/360,i=0===a?0:a/s,{h:n||1,s:i,b:s,a:r||1}},setColor:function(t){t=t.toLowerCase();for(var e in o.stringParsers)if(o.stringParsers.hasOwnProperty(e)){var r=o.stringParsers[e],n=r.re.exec(t),i=n&&r.parse(n);if(i)return this.value=this.RGBtoHSB.apply(null,i),!1}},setHue:function(o){this.value.h=1-o},setSaturation:function(o){this.value.s=o},setLightness:function(o){this.value.b=1-o},setAlpha:function(o){this.value.a=parseInt(100*(1-o),10)/100},toRGB:function(o,t,e,r){o||(o=this.value.h,t=this.value.s,e=this.value.b),o*=360;var n,i,s,a,l;return o=o%360/60,l=e*t,a=l*(1-Math.abs(o%2-1)),n=i=s=e-l,o=~~o,n+=[l,a,0,0,a,l][o],i+=[a,l,l,a,0,0][o],s+=[0,0,a,l,l,a][o],{r:Math.round(255*n),g:Math.round(255*i),b:Math.round(255*s),a:r||this.value.a}},toHex:function(o,t,e,r){var n=this.toRGB(o,t,e,r);return"#"+(1<<24|parseInt(n.r,10)<<16|parseInt(n.g,10)<<8|parseInt(n.b,10)).toString(16).substr(1)}}}]).factory("colorpicker.slider",function(){"use strict";var o={maxLeft:0,maxTop:0,callLeft:null,callTop:null,knob:{top:0,left:0}},t={};return{getOffset:function(o){for(var t=0,e=0,r=o.getBoundingClientRect();o&&!isNaN(o.offsetLeft)&&!isNaN(o.offsetTop);)"BODY"===o.tagName?(t+=document.documentElement.scrollLeft||o.scrollLeft,e+=document.documentElement.scrollTop||o.scrollTop):(t+=o.scrollLeft,e+=o.scrollTop),o=o.offsetParent;return{top:r.top+window.pageYOffset,left:r.left-130+window.pageXOffset,scrollX:t,scrollY:e}},closestSlider:function(o){var t=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.msMatchesSelector;return t.bind(o)("I")?o.parentNode:o},getSlider:function(){return o},getLeftPosition:function(e){return Math.max(0,Math.min(o.maxLeft,o.left+((e.pageX||t.left)-t.left)))},getTopPosition:function(e){return Math.max(0,Math.min(o.maxTop,o.top+((e.pageY||t.top)-t.top)))},setSlider:function(e){var r=this.closestSlider(e.target),n=this.getOffset(r),i=r.getBoundingClientRect(),s=e.clientX-i.left,a=e.clientY-i.top;o.knob=r.children[0].style,o.left=e.pageX-n.left-window.pageXOffset+n.scrollX,o.top=e.pageY-n.top-window.pageYOffset+n.scrollY,t={left:e.pageX-(s-o.left),top:e.pageY-(a-o.top)}},setSaturation:function(t){o={maxLeft:200,maxTop:200,callLeft:"setSaturation",callTop:"setLightness"},this.setSlider(t)},setHue:function(t){o={maxLeft:0,maxTop:200,callLeft:!1,callTop:"setHue"},this.setSlider(t)},setAlpha:function(t){o={maxLeft:0,maxTop:200,callLeft:!1,callTop:"setAlpha"},this.setSlider(t)},setKnob:function(t,e){o.knob.top=t+"px",o.knob.left=e+"px"}}}).directive("colorpicker",["$document","$compile","colorpicker.transColor","colorpicker.slider","colorpicker.helper",function(o,t,e,r,n){"use strict";return{restrict:"AE",replace:!0,scope:{color:"="},template:'<div class="colorpicker-circle">    <div class="circle-inner" ng-style="{\'background-color\':color}"></div></div>',link:function(i,s,a,l){function c(){clearTimeout(w),w=setTimeout(function(){b.css(A()),clearTimeout(w)},100)}i.show=!1,i.colorTab=1,i.colorboxs=["rgba(81,167,249,1)","rgba(112,191,65,1)","rgba(245,211,40,1)","rgba(243,144,25,1)","rgba(236,93,87,1)","rgba(179,106,226,1)","rgba(3,101,192,1)","rgba(0,136,43,1)","rgba(220,189,35,1)","rgba(222,106,16,1)","rgba(200,37,6,1)","rgba(119,63,155,1)","rgba(22,79,134,1)","rgba(11,93,24,1)","rgba(195,151,26,1)","rgba(189,91,12,1)","rgba(134,16,1,1)","rgba(95,50,124,1)","rgba(0,36,82,1)","rgba(5,65,9,1)","rgba(163,117,18,1)","rgba(146,70,7,1)","rgba(87,7,6,1)","rgba(59,31,78,1)","rgba(255,255,255,1)","rgba(220,222,224,1)","rgba(166,170,169,1)","rgba(83,88,95,1)","rgba(0,0,0,1)"],i.historyColorboxs=[];var u=a.colorType,f=angular.element(document.body),p='<div class="colorpicker-mask" ng-show="show" ng-click="select()"></div><div class="colorpicker dropdown" ng-show="show">     <div class="colorpicker-preview">       <div class="inner">       <div class="color-text"></div>       <div class="color-tabs">        <div class="color-tab" ng-class="{true: \'active\', false: \'\'}[colorTab === 1]" ng-click="toggleTab(1)">经典</div>        <div class="color-tab" ng-class="{true: \'active\', false: \'\'}[colorTab === 2]" ng-click="toggleTab(2)">自定义</div>        <div class="color-tab" ng-class="{true: \'active\', false: \'\'}[colorTab === 3]" ng-click="toggleTab(3)">历史记录</div>       </div>       </div>     </div>     <div class="tab-colorbox" ng-show="colorTab ===1">       <div ng-repeat="item in colorboxs">          <div class="color-unit" ng-attr-style="background-color:{{::item}}" ng-class="{true:\'active\',false:\'\'}[color === item]" ng-click="selectColorBox(item,$index)"></div>       </div>     </div>     <div class="tab-slider" ng-show="colorTab ===2">       <div class="colorpicker-saturation"><i></i></div>       <div class="colorpicker-hue"><i></i></div>       <div class="colorpicker-alpha"><i></i></div>     </div>     <div class="tab-historyColorbox" ng-show="colorTab ===3">       <div ng-repeat="item in historyColorboxs">          <div class="color-unit" ng-attr-style="background-color:{{::item}}" ng-class="{true:\'active\',false:\'\'}[color === item]" ng-click="selectColorBox(item,$index)"></div>       </div>     </div>     <div class="btn-group">        <button class="cancel" ng-click="cancel()">取消</button>        <button class="select" ng-click="select()">选择</button>     </div></div>',d=angular.element(p),g=d.eq(0),b=d.eq(1),v=b.find(".colorpicker-hue"),h=b.find(".colorpicker-saturation"),m=b.find(".colorpicker-preview"),k=b.find("i");t(d)(i),f.append(d);var x,C,w,T=e,y=24;i.toggleTab=function(o){i.colorTab=o,I()},i.selectColorBox=function(o,t){T.setColor(o),i.color=T[u](),L()},i.cancel=function(){i.color=C,P("cancel")},i.select=function(){P()};var S=function(){o.on("mousemove",B),o.on("mouseup",M)};"rgba"===u&&(b.addClass("alpha"),x=b.find(".colorpicker-alpha"),x.on("click",function(o){r.setAlpha(o),B(o)}).on("mousedown",function(o){r.setAlpha(o),S()})),v.on("click",function(o){r.setHue(o),B(o)}).on("mousedown",function(o){r.setHue(o),S()}),h.on("click",function(o){r.setSaturation(o),B(o)}).on("mousedown",function(o){r.setSaturation(o),S()});var L=function(){try{m.find(".color-text").text(T[u]()),m.find(".inner").css("backgroundColor",T[u]())}catch(o){m.find(".color-text").text(T[u]()),m.find(".inner").css("backgroundColor",T.toHex())}h.css("backgroundColor",T.toHex(T.value.h,1,1,1)),"rgba"===u&&(x.css.backgroundColor=T.toHex())},B=function(o){var t=r.getLeftPosition(o),e=r.getTopPosition(o),n=r.getSlider();r.setKnob(e,t),n.callLeft&&T[n.callLeft].call(T,t/200),n.callTop&&T[n.callTop].call(T,e/200),L();var s=T[u]();return b.find(".colorpicker-alpha").css({"background-color":s}),i.$apply(function(){i.color=s}),!1},M=function(){o.off("mousemove",B),o.off("mouseup",M)},I=function(){var o=T[u]();T.setColor(o),k.eq(0).css({left:200*T.value.s+"px",top:200-200*T.value.b+"px"}),b.find(".colorpicker-alpha").css({"background-color":o}),k.eq(1).css("top",200*(1-T.value.h)+"px"),k.eq(2).css("top",200*(1-T.value.a)+"px"),L()},A=function(o){var t,e=b.width(),r=b.height(),n=s[0].getBoundingClientRect(),i=n.left,a=n.top,l=($(window).width(),$(window).height());return b.removeClass("position-top"),b.removeClass("position-right"),b.removeClass("position-bottom"),b.removeClass("position-left"),i>e&&l-a>=r?(t={top:a-6,left:i-e+10},b.addClass("position-left")):i>e&&r>l-a?(t={top:a-r+25,left:i-e+10},b.addClass("position-top")):e>i&&l-a>=r?(t={top:a-6,left:i+20},b.addClass("position-right")):(t={top:a-r+25,left:i+20},b.addClass("position-bottom")),{top:t.top+"px",left:t.left+"px"}},H=function(o){C=angular.copy(i.color),I(),i.$apply(function(){i.show=!0,i.historyColorboxs=n.getCookie("historyColor").split("|")}),b.css(A(o)),g.css({"z-index":parseInt((new Date).getTime())}),b.css({"z-index":parseInt((new Date).getTime())})};s.on("click",H),b.on("mousedown",function(o){o.stopPropagation(),o.preventDefault()});var P=function(o){i.show=!1,"cancel"!==o&&R()},R=function(){var o=T[u](),t="historyColor";if(n.enabledCookie(t)){for(var e=n.getCookie(t),r=e.split("|"),i=0;i<r.length;i++)if(o===r[i])return r.splice(i,1),r.unshift(o),void n.setCookie(t,r.join("|"));r.length>=y?(r.pop(),r.unshift(o),n.setCookie(t,r.join("|"))):n.setCookie(t,o+"|"+e)}else n.setCookie(t,o)};o.bind("scroll",function(){c()}),$(window).on("resize",function(){c()})}}}]);