angular.module("ui.colorpicker",[]).factory("colorpicker.helper",["$document",function(o){return{setCookie:function(o,e){var t=30,r=new Date;r.setTime(r.getTime()+24*t*60*60*1e3),document.cookie=o+"="+escape(e)+";expires="+r.toGMTString()},getCookie:function(o){var e,t=new RegExp("(^| )"+o+"=([^;]*)(;|$)");return(e=document.cookie.match(t))?unescape(e[2]):null},deleteCookie:function(o){var e=new Date;e.setTime(e.getTime()-1);var t=getCookie(o);null!=t&&(document.cookie=o+"="+t+";expires="+e.toGMTString())},enabledCookie:function(o){return"string"==typeof this.getCookie(o)?!0:!1},stringParsers:[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(o){return[o[1],o[2],o[3],o[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(o){return[2.55*o[1],2.55*o[2],2.55*o[3],o[4]]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,parse:function(o){return[parseInt(o[1],16),parseInt(o[2],16),parseInt(o[3],16)]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/,parse:function(o){return[parseInt(o[1]+o[1],16),parseInt(o[2]+o[2],16),parseInt(o[3]+o[3],16)]}}]}}]).factory("colorpicker.transColor",["colorpicker.helper",function(o){return{value:{h:1,s:1,b:1,a:1},rgb:function(){var o=this.toRGB();return"rgb("+o.r+","+o.g+","+o.b+")"},rgba:function(){var o=this.toRGB();return"rgba("+o.r+","+o.g+","+o.b+","+o.a+")"},hex:function(){return this.toHex()},RGBtoHSB:function(o,e,t,r){o/=255,e/=255,t/=255;var n,i,s,a;return s=Math.max(o,e,t),a=s-Math.min(o,e,t),n=0===a?null:s===o?(e-t)/a:s===e?(t-o)/a+2:(o-e)/a+4,n=(n+360)%6*60/360,i=0===a?0:a/s,{h:n||1,s:i,b:s,a:r||1}},setColor:function(e){e=e.toLowerCase();for(var t in o.stringParsers)if(o.stringParsers.hasOwnProperty(t)){var r=o.stringParsers[t],n=r.re.exec(e),i=n&&r.parse(n);if(i)return this.value=this.RGBtoHSB.apply(null,i),!1}},setHue:function(o){this.value.h=1-o},setSaturation:function(o){this.value.s=o},setLightness:function(o){this.value.b=1-o},setAlpha:function(o){this.value.a=parseInt(100*(1-o),10)/100},toRGB:function(o,e,t,r){o||(o=this.value.h,e=this.value.s,t=this.value.b),o*=360;var n,i,s,a,l;return o=o%360/60,l=t*e,a=l*(1-Math.abs(o%2-1)),n=i=s=t-l,o=~~o,n+=[l,a,0,0,a,l][o],i+=[a,l,l,a,0,0][o],s+=[0,0,a,l,l,a][o],{r:Math.round(255*n),g:Math.round(255*i),b:Math.round(255*s),a:r||this.value.a}},toHex:function(o,e,t,r){var n=this.toRGB(o,e,t,r);return"#"+(1<<24|parseInt(n.r,10)<<16|parseInt(n.g,10)<<8|parseInt(n.b,10)).toString(16).substr(1)}}}]).factory("colorpicker.slider",function(){"use strict";var o={maxLeft:0,maxTop:0,callLeft:null,callTop:null,knob:{top:0,left:0}},e={};return{getOffset:function(o){for(var e=0,t=0,r=o.getBoundingClientRect();o&&!isNaN(o.offsetLeft)&&!isNaN(o.offsetTop);)"BODY"===o.tagName?(e+=document.documentElement.scrollLeft||o.scrollLeft,t+=document.documentElement.scrollTop||o.scrollTop):(e+=o.scrollLeft,t+=o.scrollTop),o=o.offsetParent;return{top:r.top+window.pageYOffset,left:r.left-130+window.pageXOffset,scrollX:e,scrollY:t}},closestSlider:function(o){var e=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.msMatchesSelector;return e.bind(o)("I")?o.parentNode:o},getSlider:function(){return o},getLeftPosition:function(t){return Math.max(0,Math.min(o.maxLeft,o.left+((t.pageX||e.left)-e.left)))},getTopPosition:function(t){return Math.max(0,Math.min(o.maxTop,o.top+((t.pageY||e.top)-e.top)))},setSlider:function(t){var r=this.closestSlider(t.target),n=this.getOffset(r),i=r.getBoundingClientRect(),s=t.clientX-i.left,a=t.clientY-i.top;o.knob=r.children[0].style,o.left=t.pageX-n.left-window.pageXOffset+n.scrollX,o.top=t.pageY-n.top-window.pageYOffset+n.scrollY,e={left:t.pageX-(s-o.left),top:t.pageY-(a-o.top)}},setSaturation:function(e){o={maxLeft:200,maxTop:200,callLeft:"setSaturation",callTop:"setLightness"},this.setSlider(e)},setHue:function(e){o={maxLeft:0,maxTop:200,callLeft:!1,callTop:"setHue"},this.setSlider(e)},setAlpha:function(e){o={maxLeft:0,maxTop:200,callLeft:!1,callTop:"setAlpha"},this.setSlider(e)},setKnob:function(e,t){o.knob.top=e+"px",o.knob.left=t+"px"}}}).directive("colorpicker",["$document","$compile","colorpicker.transColor","colorpicker.slider","colorpicker.helper",function(o,e,t,r,n){"use strict";return{restrict:"AE",replace:!0,scope:{color:"="},template:'<div class="colorpicker-circle">    <div class="circle-inner" ng-style="{\'background-color\':color}"></div></div>',link:function(i,s,a,l){function c(){clearTimeout(T),T=setTimeout(function(){b.css(P()),clearTimeout(T)},100)}i.show=!1,i.colorTab=1,i.colorboxs=["rgba(81,167,249,1)","rgba(112,191,65,1)","rgba(245,211,40,1)","rgba(243,144,25,1)","rgba(236,93,87,1)","rgba(179,106,226,1)","rgba(3,101,192,1)","rgba(0,136,43,1)","rgba(220,189,35,1)","rgba(222,106,16,1)","rgba(200,37,6,1)","rgba(119,63,155,1)","rgba(22,79,134,1)","rgba(11,93,24,1)","rgba(195,151,26,1)","rgba(189,91,12,1)","rgba(134,16,1,1)","rgba(95,50,124,1)","rgba(0,36,82,1)","rgba(5,65,9,1)","rgba(163,117,18,1)","rgba(146,70,7,1)","rgba(87,7,6,1)","rgba(59,31,78,1)","rgba(255,255,255,1)","rgba(220,222,224,1)","rgba(166,170,169,1)","rgba(83,88,95,1)","rgba(0,0,0,1)"],i.historyColorboxs=[];var u="historyColor-"+a.colorType,p=a.colorType,f=angular.element(document.body),d='<div class="colorpicker-mask" ng-show="show" ng-click="select()"></div><div class="colorpicker dropdown" ng-show="show">     <div class="colorpicker-preview">       <div class="inner">       <div class="color-text"></div>       <div class="color-tabs">        <div class="color-tab" ng-class="{true: \'active\', false: \'\'}[colorTab === 1]" ng-click="toggleTab(1)">经典</div>        <div class="color-tab" ng-class="{true: \'active\', false: \'\'}[colorTab === 2]" ng-click="toggleTab(2)">自定义</div>        <div class="color-tab" ng-class="{true: \'active\', false: \'\'}[colorTab === 3]" ng-click="toggleTab(3)">历史记录</div>       </div>       </div>     </div>     <div class="tab-colorbox" ng-show="colorTab ===1">       <div ng-repeat="item in colorboxs">          <div class="color-unit" ng-attr-style="background-color:{{::item}}" ng-class="{true:\'active\',false:\'\'}[color === item]" ng-click="selectColorBox(item,$index)"></div>       </div>     </div>     <div class="tab-slider" ng-show="colorTab ===2">       <div class="colorpicker-saturation"><i></i></div>       <div class="colorpicker-hue"><i></i></div>       <div class="colorpicker-alpha"><i></i></div>     </div>     <div class="tab-historyColorbox" ng-show="colorTab ===3">       <div ng-repeat="item in historyColorboxs">           <div class="color-unit-wrap">               <div class="color-unit" ng-attr-style="background-color:{{::item}}" ng-class="{true:\'active\',false:\'\'}[color === item]" ng-click="selectColorBox(item,$index)"></div>           </div>       </div>     </div>     <div class="btn-group">        <button class="cancel" ng-click="cancel()">取消</button>        <button class="select" ng-click="select()">选择</button>     </div></div>',g=angular.element(d),v=g.eq(0),b=g.eq(1),h=b.find(".colorpicker-hue"),m=b.find(".colorpicker-saturation"),k=b.find(".colorpicker-preview"),x=b.find("i");e(g)(i),f.append(g);var w,C,T,y=t,S=24;i.toggleTab=function(o){i.colorTab=o,A()},i.selectColorBox=function(o,e){y.setColor(o),i.color=y[p](),B()},i.cancel=function(){i.color=C,R("cancel")},i.select=function(){R()};var L=function(){o.on("mousemove",M),o.on("mouseup",I)};"rgba"===p&&(b.addClass("alpha"),w=b.find(".colorpicker-alpha"),w.on("click",function(o){r.setAlpha(o),M(o)}).on("mousedown",function(o){r.setAlpha(o),L()})),h.on("click",function(o){r.setHue(o),M(o)}).on("mousedown",function(o){r.setHue(o),L()}),m.on("click",function(o){r.setSaturation(o),M(o)}).on("mousedown",function(o){r.setSaturation(o),L()});var B=function(){k.find(".color-text").text(y[p]()),k.find(".inner").css("backgroundColor",y[p]()),m.css("backgroundColor",y.toHex(y.value.h,1,1,1))},M=function(o){var e=r.getLeftPosition(o),t=r.getTopPosition(o),n=r.getSlider();r.setKnob(t,e),n.callLeft&&y[n.callLeft].call(y,e/200),n.callTop&&y[n.callTop].call(y,t/200),B();var s=y[p]();return b.find(".colorpicker-alpha").css({"background-color":s}),i.$apply(function(){i.color=s}),!1},I=function(){o.off("mousemove",M),o.off("mouseup",I)},A=function(){var o=y[p]();y.setColor(o),x.eq(0).css({left:200*y.value.s+"px",top:200-200*y.value.b+"px"}),b.find(".colorpicker-alpha").css({"background-color":o}),x.eq(1).css("top",200*(1-y.value.h)+"px"),x.eq(2).css("top",200*(1-y.value.a)+"px"),B()},P=function(o){var e,t=b.width(),r=b.height(),n=s[0].getBoundingClientRect(),i=n.left,a=n.top,l=($(window).width(),$(window).height());return b.removeClass("position-top"),b.removeClass("position-right"),b.removeClass("position-bottom"),b.removeClass("position-left"),i>t&&l-a>=r?(e={top:a-6,left:i-t+10},b.addClass("position-left")):i>t&&r>l-a?(e={top:a-r+25,left:i-t+10},b.addClass("position-top")):t>i&&l-a>=r?(e={top:a-6,left:i+20},b.addClass("position-right")):(e={top:a-r+25,left:i+20},b.addClass("position-bottom")),{top:e.top+"px",left:e.left+"px"}},H=function(o){C=angular.copy(i.color),y.setColor(C),A();var e=n.getCookie(u);e=null===e?[]:e.split("|"),i.$apply(function(){i.show=!0,i.historyColorboxs=e}),b.css(P(o)),v.css({"z-index":parseInt((new Date).getTime(),10)}),b.css({"z-index":parseInt((new Date).getTime(),10)})};s.on("click",H),b.on("mousedown",function(o){o.stopPropagation(),o.preventDefault()});var R=function(o){i.show=!1,"cancel"!==o&&Y()},Y=function(){var o=y[p]();if(n.enabledCookie(u)){for(var e=n.getCookie(u),t=e.split("|"),r=0;r<t.length;r++)if(o===t[r])return t.splice(r,1),t.unshift(o),void n.setCookie(u,t.join("|"));t.length>=S?(t.pop(),t.unshift(o),n.setCookie(u,t.join("|"))):n.setCookie(u,o+"|"+e)}else n.setCookie(u,o)};o.bind("scroll",function(){c()}),$(window).on("resize",function(){c()})}}}]);