angular.module("ui.colorpicker",[]).factory("colorpicker.helper",["$document",function(o){return{setCookie:function(o,e){var t=30,r=new Date;r.setTime(r.getTime()+24*t*60*60*1e3),document.cookie=o+"="+escape(e)+";expires="+r.toGMTString()},getCookie:function(o){var e,t=new RegExp("(^| )"+o+"=([^;]*)(;|$)");return(e=document.cookie.match(t))?unescape(e[2]):null},deleteCookie:function(o){var e=new Date;e.setTime(e.getTime()-1);var t=getCookie(o);null!=t&&(document.cookie=o+"="+t+";expires="+e.toGMTString())},enabledCookie:function(o){return"string"==typeof this.getCookie(o)?!0:!1},stringParsers:[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(o){return[o[1],o[2],o[3],o[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(o){return[2.55*o[1],2.55*o[2],2.55*o[3],o[4]]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,parse:function(o){return[parseInt(o[1],16),parseInt(o[2],16),parseInt(o[3],16)]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/,parse:function(o){return[parseInt(o[1]+o[1],16),parseInt(o[2]+o[2],16),parseInt(o[3]+o[3],16)]}}]}}]).factory("colorpicker.transColor",["colorpicker.helper",function(o){return{value:{h:1,s:1,b:1,a:1},rgba:function(){var o=this.toRGB();return"rgba("+o.r+","+o.g+","+o.b+","+o.a+")"},hex:function(){return this.toHex()},RGBtoHSB:function(o,e,t,r){o/=255,e/=255,t/=255;var n,i,s,a;return s=Math.max(o,e,t),a=s-Math.min(o,e,t),n=0===a?null:s===o?(e-t)/a:s===e?(t-o)/a+2:(o-e)/a+4,n=(n+360)%6*60/360,i=0===a?0:a/s,{h:n||1,s:i,b:s,a:r||1}},setColor:function(e){e=e.toLowerCase();for(var t in o.stringParsers)if(o.stringParsers.hasOwnProperty(t)){var r=o.stringParsers[t],n=r.re.exec(e),i=n&&r.parse(n);if(i)return this.value=this.RGBtoHSB.apply(null,i),!1}},setHue:function(o){this.value.h=1-o},setSaturation:function(o){this.value.s=o},setLightness:function(o){this.value.b=1-o},setAlpha:function(o){this.value.a=parseInt(100*(1-o),10)/100},toRGB:function(o,e,t,r){o||(o=this.value.h,e=this.value.s,t=this.value.b),o*=360;var n,i,s,a,l;return o=o%360/60,l=t*e,a=l*(1-Math.abs(o%2-1)),n=i=s=t-l,o=~~o,n+=[l,a,0,0,a,l][o],i+=[a,l,l,a,0,0][o],s+=[0,0,a,l,l,a][o],{r:Math.round(255*n),g:Math.round(255*i),b:Math.round(255*s),a:r||this.value.a}},toHex:function(o,e,t,r){var n=this.toRGB(o,e,t,r);return"#"+(1<<24|parseInt(n.r,10)<<16|parseInt(n.g,10)<<8|parseInt(n.b,10)).toString(16).substr(1)}}}]).factory("colorpicker.slider",function(){"use strict";var o={maxLeft:0,maxTop:0,callLeft:null,callTop:null,knob:{top:0,left:0}},e={};return{getOffset:function(o){for(var e=0,t=0,r=o.getBoundingClientRect();o&&!isNaN(o.offsetLeft)&&!isNaN(o.offsetTop);)"BODY"===o.tagName?(e+=document.documentElement.scrollLeft||o.scrollLeft,t+=document.documentElement.scrollTop||o.scrollTop):(e+=o.scrollLeft,t+=o.scrollTop),o=o.offsetParent;return{top:r.top+window.pageYOffset,left:r.left-130+window.pageXOffset,scrollX:e,scrollY:t}},closestSlider:function(o){var e=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.msMatchesSelector;return e.bind(o)("I")?o.parentNode:o},getSlider:function(){return o},getLeftPosition:function(t){return Math.max(0,Math.min(o.maxLeft,o.left+((t.pageX||e.left)-e.left)))},getTopPosition:function(t){return Math.max(0,Math.min(o.maxTop,o.top+((t.pageY||e.top)-e.top)))},setSlider:function(t){var r=this.closestSlider(t.target),n=this.getOffset(r),i=r.getBoundingClientRect(),s=t.clientX-i.left,a=t.clientY-i.top;o.knob=r.children[0].style,o.left=t.pageX-n.left-window.pageXOffset+n.scrollX,o.top=t.pageY-n.top-window.pageYOffset+n.scrollY,e={left:t.pageX-(s-o.left),top:t.pageY-(a-o.top)}},setSaturation:function(e){o={maxLeft:200,maxTop:200,callLeft:"setSaturation",callTop:"setLightness"},this.setSlider(e)},setHue:function(e){o={maxLeft:0,maxTop:200,callLeft:!1,callTop:"setHue"},this.setSlider(e)},setAlpha:function(e){o={maxLeft:0,maxTop:200,callLeft:!1,callTop:"setAlpha"},this.setSlider(e)},setKnob:function(e,t){o.knob.top=e+"px",o.knob.left=t+"px"}}}).directive("colorpicker",["$document","$compile","colorpicker.transColor","colorpicker.slider","colorpicker.helper",function(o,e,t,r,n){"use strict";return{restrict:"AE",replace:!0,scope:{color:"="},template:'<div class="colorpicker-circle">    <div class="circle-inner" ng-style="{\'background-color\':color}"></div></div>',link:function(i,s,a,l){function c(){clearTimeout(w),w=setTimeout(function(){v.css(A()),clearTimeout(w)},100)}i.show=!1,i.colorTab=1,i.colorboxs=["rgba(81,167,249,1)","rgba(112,191,65,1)","rgba(245,211,40,1)","rgba(243,144,25,1)","rgba(236,93,87,1)","rgba(179,106,226,1)","rgba(3,101,192,1)","rgba(0,136,43,1)","rgba(220,189,35,1)","rgba(222,106,16,1)","rgba(200,37,6,1)","rgba(119,63,155,1)","rgba(22,79,134,1)","rgba(11,93,24,1)","rgba(195,151,26,1)","rgba(189,91,12,1)","rgba(134,16,1,1)","rgba(95,50,124,1)","rgba(0,36,82,1)","rgba(5,65,9,1)","rgba(163,117,18,1)","rgba(146,70,7,1)","rgba(87,7,6,1)","rgba(59,31,78,1)","rgba(255,255,255,1)","rgba(220,222,224,1)","rgba(166,170,169,1)","rgba(83,88,95,1)","rgba(0,0,0,1)"],i.historyColorboxs=[];var u=a.colorType,p=angular.element(document.body),f='<div class="colorpicker-mask" ng-show="show" ng-click="select()"></div><div class="colorpicker dropdown" ng-show="show">     <div class="colorpicker-preview">       <div class="inner">       <div class="color-text"></div>       <div class="color-tabs">        <div class="color-tab" ng-class="{true: \'active\', false: \'\'}[colorTab === 1]" ng-click="toggleTab(1)">经典</div>        <div class="color-tab" ng-class="{true: \'active\', false: \'\'}[colorTab === 2]" ng-click="toggleTab(2)">自定义</div>        <div class="color-tab" ng-class="{true: \'active\', false: \'\'}[colorTab === 3]" ng-click="toggleTab(3)">历史记录</div>       </div>       </div>     </div>     <div class="tab-colorbox" ng-show="colorTab ===1">       <div ng-repeat="item in colorboxs">          <div class="color-unit" ng-attr-style="background-color:{{::item}}" ng-class="{true:\'active\',false:\'\'}[color === item]" ng-click="selectColorBox(item,$index)"></div>       </div>     </div>     <div class="tab-slider" ng-show="colorTab ===2">       <div class="colorpicker-saturation"><i></i></div>       <div class="colorpicker-hue"><i></i></div>       <div class="colorpicker-alpha"><i></i></div>     </div>     <div class="tab-historyColorbox" ng-show="colorTab ===3">       <div ng-repeat="item in historyColorboxs">          <div class="color-unit" ng-attr-style="background-color:{{::item}}" ng-class="{true:\'active\',false:\'\'}[color === item]" ng-click="selectColorBox(item,$index)"></div>       </div>     </div>     <div class="btn-group">        <button class="cancel" ng-click="cancel()">取消</button>        <button class="select" ng-click="select()">选择</button>     </div></div>',d=angular.element(f),g=d.eq(0),v=d.eq(1),b=v.find(".colorpicker-hue"),h=v.find(".colorpicker-saturation"),m=v.find(".colorpicker-preview"),k=v.find("i");e(d)(i),p.append(d);var x,C,w,T=t,y=24;i.toggleTab=function(o){i.colorTab=o,I()},i.selectColorBox=function(o,e){T.setColor(o),i.color=o,L()},i.cancel=function(){i.color=C,P("cancel")},i.select=function(){P()};var S=function(){o.on("mousemove",M),o.on("mouseup",B)};"rgba"===u&&(v.addClass("alpha"),x=v.find(".colorpicker-alpha"),x.on("click",function(o){r.setAlpha(o),M(o)}).on("mousedown",function(o){r.setAlpha(o),S()})),b.on("click",function(o){r.setHue(o),M(o)}).on("mousedown",function(o){r.setHue(o),S()}),h.on("click",function(o){r.setSaturation(o),M(o)}).on("mousedown",function(o){r.setSaturation(o),S()});var L=function(){try{m.find(".color-text").text(T[u]()),m.find(".inner").css("backgroundColor",T[u]())}catch(o){m.find(".color-text").text(T[u]()),m.find(".inner").css("backgroundColor",T.toHex())}h.css("backgroundColor",T.toHex(T.value.h,1,1,1)),"rgba"===u&&(x.css.backgroundColor=T.toHex())},M=function(o){var e=r.getLeftPosition(o),t=r.getTopPosition(o),n=r.getSlider();r.setKnob(t,e),n.callLeft&&T[n.callLeft].call(T,e/200),n.callTop&&T[n.callTop].call(T,t/200),L();var s=T[u]();return v.find(".colorpicker-alpha").css({"background-color":s}),i.$apply(function(){i.color=s}),!1},B=function(){o.off("mousemove",M),o.off("mouseup",B)},I=function(){var o=T[u]();T.setColor(o),k.eq(0).css({left:200*T.value.s+"px",top:200-200*T.value.b+"px"}),v.find(".colorpicker-alpha").css({"background-color":o}),k.eq(1).css("top",200*(1-T.value.h)+"px"),k.eq(2).css("top",200*(1-T.value.a)+"px"),L()},A=function(o){var e,t=v.width(),r=v.height(),n=s[0].getBoundingClientRect(),i=n.left,a=n.top,l=($(window).width(),$(window).height());return v.removeClass("position-top"),v.removeClass("position-right"),v.removeClass("position-bottom"),v.removeClass("position-left"),i>t&&l-a>=r?(e={top:a-6,left:i-t+10},v.addClass("position-left")):i>t&&r>l-a?(e={top:a-r+25,left:i-t+10},v.addClass("position-top")):t>i&&l-a>=r?(e={top:a-6,left:i+20},v.addClass("position-right")):(e={top:a-r+25,left:i+20},v.addClass("position-bottom")),{top:e.top+"px",left:e.left+"px"}},H=function(o){C=angular.copy(i.color),I(),i.$apply(function(){i.show=!0,i.historyColorboxs=n.getCookie("historyColor").split("|")}),v.css(A(o)),g.css({"z-index":parseInt((new Date).getTime())}),v.css({"z-index":parseInt((new Date).getTime())})};s.on("click",H),v.on("mousedown",function(o){o.stopPropagation(),o.preventDefault()});var P=function(o){i.show=!1,"cancel"!==o&&R()},R=function(){var o=T[u](),e="historyColor";if(n.enabledCookie(e)){for(var t=n.getCookie(e),r=t.split("|"),i=0;i<r.length;i++)if(o===r[i])return r.splice(i,1),r.unshift(o),void n.setCookie(e,r.join("|"));r.length>=y?(r.pop(),r.unshift(o),n.setCookie(e,r.join("|"))):n.setCookie(e,o+"|"+t)}else n.setCookie(e,o)};o.bind("scroll",function(){c()}),$(window).on("resize",function(){c()})}}}]);